{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'songplayer.css' %}">
</head>

<body>

    <div class="nav-buttons">
        <a href="{% url 'homeChatViewLogic' %}" class="nav-button">
            <i class="fas fa-home"></i> Home
        </a>
        <a href="{% url 'profile' username=userinfo.username %}" class="nav-button">
            <i class="fas fa-user"></i> Profile
        </a>
    </div>

    <div class="sidebar">
        {% if songs %}
            {% for song in songs %}
                <div class="song-item">
                    <a id="play-button"
                       href="{% url 'Player' username=userinfo.username clickedplaylist=song.genre id=song.song_id %}">
                        <img src="{{ song.thumbnail.url }}" alt="{{ song.genre }}" class="playlist-cover">
                        <div class="song-info">
                            <h3>{{ song.title }}</h3>
                            <p>{{ song.artist }}</p>
                        </div>
                    </a>
                </div>
            {% endfor %}
        {% else %}
            <div class="song-item">
                <div class="song-info">
                    <h3>No Songs Yet</h3>
                    <p>Your favorite songs will appear here once you start liking them during your chat.</p>
                </div>
            </div>
        {% endif %}
    </div>

    {% if clickedsong %}
        <div class="main-player">
            <div class="now-playing">
                <img src="{{ clickedsong.thumbnail.url }}" alt="Current Track" class="current-artwork">
                <div class="song-info">
                    <h2>{{ clickedsong.title }}</h2>
                    <p>{{ clickedsong.artist }}</p>
                </div>
            </div>

            <audio id="audio-player" controls>
                <source src="{{ clickedsong.song.url }}" type="audio/mpeg" autoplay>
                Your browser does not support the audio element.
            </audio>

            <div class="lyrics-section">
                <h3>Lyrics</h3>
                <div id="lyrics-container"></div>
            </div>
        </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const music = document.getElementById("audio-player");
            const lyricsContainer = document.getElementById("lyrics-container");
            const lyrics = {{ clickedsong.lyrics|safe }};
        
            // Check if there's a song loaded and autoplay it
            if (music) {
                music.autoplay = true; // Enable autoplay
                music.load();          // Ensure the audio source is loaded
            }
        
            function parseTime(timeString) {
                const [minutes, seconds] = timeString.split(':');
                return parseInt(minutes) * 60 + parseFloat(seconds);
            }
        
            function displayLyrics() {
                lyricsContainer.innerHTML = ''; 
        
                lyrics.forEach((line, index) => {
                    const lyricElement = document.createElement('p');
                    lyricElement.id = `lyric-${index}`;
                    lyricElement.className = 'lyric-line';
                    lyricsContainer.appendChild(lyricElement);
        
                    setTimeout(() => {
                        lyricElement.textContent = line.lyrics;
                        lyricElement.style.opacity = 1;
        
                        lyricElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, parseTime(line.time) * 1000); 
                });
            }
        
            music.addEventListener('play', displayLyrics);
        
            music.addEventListener('timeupdate', () => {
                const currentTime = music.currentTime;
                lyrics.forEach((line, index) => {
                    const lyricElement = document.getElementById(`lyric-${index}`);
                    if (lyricElement) {
                        if (currentTime >= parseTime(line.time)) {
                            lyricElement.classList.add('highlight');
                        } else {
                            lyricElement.classList.remove('highlight');
                        }
                    }
                });
            });
        });
        </script>
</body>

</html>
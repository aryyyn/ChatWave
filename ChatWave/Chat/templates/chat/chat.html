{% load static %}
{% load custom_filters %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>ChatWave | Chat</title>

    <link rel="stylesheet" href="{% static 'chatstyle.css' %}">


</head>

<body>
    <div class="container">
        <div class="side-nav">
            <div class="nav-top">
                <a class="nav-button" href="{% url 'homeChatViewLogic' %}">üè†</a>

                <button class="nav-button">‚öôÔ∏è</button>
            </div>
            <button class="nav-button profile-button">üë§</button>
        </div>

        <div class="chat-rooms">
            <div class="chat-rooms-header">
                <h2>Chat Rooms</h2>
                <form method="post">
                    {% csrf_token %}
                    <button class="add-room" name="action" value="add-room">+</button>
                </form>
            </div>
            <div class="room-list">

                <div class="room-category">
                    <h3>General</h3>
                    <a href="{% url 'chatViewLogic' chatroom='General_Chat' %}">
                        <div class="room-item">General Chat</div>
                    </a>
                    <a href="{% url 'chatViewLogic' chatroom='General_Chat_2' %}">
                        <div class="room-item">General Chat 2</div>
                    </a>
                </div>

                <div class="room-category">
                    <h3>Music</h3>
                    <a href="{% url 'chatViewLogic' chatroom='Music_Chat' %}">
                        <div class="room-item">Music Chat</div>
                    </a>
                    <a href="{% url 'chatViewLogic' chatroom='Music_Chat_2' %}">
                        <div class="room-item">Music Chat 2</div>
                    </a>
                </div>

                <div class="room-category">
                    <h3>Gaming</h3>
                    <a href="{% url 'chatViewLogic' chatroom='Game_Chat' %}">
                        <div class="room-item">Game Chat</div>
                    </a>
                    <a href="{% url 'chatViewLogic' chatroom='Game_Chat_2' %}">
                        <div class="room-item">Game Chat 2</div>
                    </a>
                </div>

                <div class="room-category">
                    <h3>Other</h3>

                    {% for ChatRoom in ChatRoomOther %}
                    {% if "Other" in ChatRoom.category %}

                    {% if request.user.username in ChatRoom.allowed %}

                    <a href="{% url 'chatViewLogic' chatroom=ChatRoom.room_name %}">
                        <div class="room-item">{{ ChatRoom.room_name|replace_underscore }}</div>
                    </a>
                    {% endif %}
                    {% endif %}
                    {% endfor %}


                </div>

            </div>
        </div>

        <div class="chat-section">
            <div class="chat-header">
                <h2>{{chat_room.room_name}}</h2>
                <div class="chat-header-actions">

                    <button>üîî</button>
                    <button>üîì</button>
                </div>
            </div>
            <div class="chat-messages">


                {% for message in chat_messages %}
                {% if not message.isDeleted%}
                {% if message.sender.username != request.user.username%}
                

                <div class="message">
                    <img src={{message.sender.profilePicture}} alt="userimage">
                    <div class="user" id="{{message.id}}"> <a id="messageUsername"
                            href="{%url 'profile' message.sender.username %}">{{ message.sender.username }} </a>
                        <div class="timestamp">{{ message.created|date:"h:i A" }}</div>
                        {% if message.message|slice:":23" == "https://media.tenor.com" %}
                        <img src="{{message.message}}" class="gif-image">
                    </div>
                    {% elif message.message|slice:":26" == "https://res.cloudinary.com" %}
                    <img src="{{message.message}}" class="sent-image">
                </div>
                {%else%}
                <h3 class="text-message"> {{ message.message }} </h3>
            </div>
            {%endif%}
        </div>




        {% else %}
       
        <div class="message sent">
            <img src="{{request.user.profilePicture}}" alt="userimage">
            <div class="user" id="{{message.id}}">You
                <button class="delete-message"><i class="fas fa-trash"></i></button>
                <div class="timestamp">{{ message.created|date:"h:i A" }} </div>
                {% if message.message|slice:":23" == "https://media.tenor.com" %}
                <img src="{{message.message}}" class="gif-image">
            </div>
            {% elif message.message|slice:":26" == "https://res.cloudinary.com" %}
            <img src="{{message.message}}" class="sent-image">
        </div>
        {%else%}
        <h3 class="text-message"> {{ message.message }} </h3>
    </div>
    {%endif%}
    
    </div>



    {%endif%}
    {% endif %}
    {% endfor %}



    </div>
    <div class="type-indicator-area">

    </div>
    <div class="input-area">

        <input type="text" class="input-chat-box" placeholder="Start typing...">
        <div class="input-actions">
            <button>‚úàÔ∏è</button>
            <button>üé•</button>
            <button>üì∏</button>

        </div>
    </div>
    </div>

    <div class="right-panel">
        <div class="music-player">

            {% if songs%}

            {% if isEligible %}
            <img src="{{ songs.thumbnail.url }}" alt="Album Art" class="album-art">


            <div class="track-info">

                <h3>{{ songs.title }}</h3>
                <p>{{ songs.artist }}</p>
            </div>
            <audio controls autoplay>
                <source src="{{ songs.song.url }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>

            {%else%}
            <img src="https://i.pinimg.com/736x/ec/e9/01/ece901e3b7a2de83e379215e778d8fb8.jpg" alt="Album Art"
                class="album-art">
            <div class="track-info">
                <h3>Not enough messages! Would you like to play a random song instead?</h3>
                <button class="randomSongYes">Yes </button>
                <button class="randomSongNo">No </button>
            </div>




            {%endif%}


            {% else %}

            <img src="https://i.pinimg.com/736x/9c/1d/df/9c1ddfa2bc9e17d4dbf4799f73622f23.jpg" alt="Album Art"
                class="album-art">
            <div class="track-info">
                <h3>Press on the '‚ûï' icon to start listening to music!</h3>
            </div>

            {% endif %}

            {% if not songPlaying%}

            <div class="player-controls">
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" id="next-song" name="action" value="add-song">‚ûï</button>
                </form>
                <button type="submit" id="like-song" name="action" value="like-song" disabled>‚ù§Ô∏è</button>

            </div>





            {%else%}

            <div class="player-controls">


                <button type="submit" id="next-song" class="next-song" name="action" value="next-song">‚û§</button>

                <button type="submit" id="like-song" name="action" value="like-song">‚ù§Ô∏è</button>



            </div>
            {%endif%}

        </div>
        <div class="users-section">
            <div class="online-count">
                <h3>Online Users</h3>
                <span id='online-count'> {{ chat_room.online_count}} active</span>

            </div>
            <ul class="users-list">
                {%for user in chat_room.online_users%}
                {% if user %}
                <li></li>
                {%endif%}
                {%endfor%}
            </ul>
        </div>
    </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div>
                <h4>Theme Selection</h4>
                <select id="themeSelect"
                    style="background: #1f1f1f; color: #fff; padding: 5px; border: 1px solid #ff336633; border-radius: 4px;">
                    <option value="default">Default</option>
                    <option value="blue_pink">Serene Skies</option>
                    <option value="darkcharcoal_yellow">Midnight Spark</option>
                    <option value="lightred_yellow">Sunset Glow</option>
                    <option value="darkblue_lightgreen">Blue Horizon</option>
                    <option value="forestgreen_mossgreen">Woodland Whisper</option>
                    <option value="pastelolivegreen_salmonpink">Peachy Meadow</option>
                </select>



            </div>
        </div>
    </div>

    <div class="gif-modal" id="gifModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>GIFs </h3>
                <button class="gif-modal-close">&times;</button>
            </div>
            <div>
                <input type="text" id="gifInput" placeholder="Search Tenor..">
                <button id="gifSearchButton">üîç</button>
            </div>
            <div id="gifresults" class="gif-results-container">

            </div>

        </div>
    </div>


    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">

            <div class="image-area">

            </div>
        </div>
    </div>

    <div class="noti-modal" id="notiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Notifications</h5>
                <button class="noti-modal-close"
                    onclick="document.getElementById('notiModal').classList.remove('active')">&times;</button>
            </div>
            <div class="noti-area">
                {% if notifications %}
                <div class="notification">
                    <div class="notification-message">
                        You have been pinged by aryn in General Chat 1.
                    </div>
                    <div class="notification-message">
                        You have been pinged by aryn in General Chat 1.
                    </div>
                </div>
                {%else%}
                <div class="notification-message">
                    No New Notifications.
                </div>
                {%endif%}

            </div>
        </div>
    </div>








    <input type="file" class="file-upload" id="fileUpload" accept="image/*">

</html>
</head>

<script>
    document.addEventListener('DOMContentLoaded', () => {


        const gifSearchButton = document.getElementById("gifSearchButton");
        const gifInput = document.getElementById("gifInput")

        gifSearchButton.addEventListener('click', () => {
            const TENOR_API_KEY = "{{TENOR_API_KEY}}";
            const clientKey = "my_test_app";
            const lmt = 8;
            const searchTerm = gifInput.value;


            const searchUrl = `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(searchTerm)}&key=${TENOR_API_KEY}&client_key=${clientKey}&limit=${lmt}`;

            fetch(searchUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const urls = data.results.map(result => result.media_formats.gif.url);


                        const resultsContainer = document.getElementById("gifresults");
                        resultsContainer.innerHTML = '';

                        urls.forEach((url, index) => {
                            const resultItem = document.createElement('div');
                            resultItem.classList.add('result-item');
                            const img = document.createElement('img');
                            img.id = `gif-${index}`;
                            img.src = url;
                            img.alt = 'GIF result';

                            img.addEventListener('click', () => {
                                sendMessage(img.src)
                            });

                            resultItem.appendChild(img);
                            resultsContainer.appendChild(resultItem);
                        });
                    }
                })
                .catch(error => console.error("Error fetching data:", error));
        });




        //for theme selection
        const settingsBtn = document.querySelector('.side-nav button:nth-child(2)');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = settingsModal.querySelector('.modal-close');

        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.toggle('active');
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('active');
        });

        const gifButton = document.querySelector(".input-actions button:nth-child(2)");
        const gifModal = document.getElementById('gifModal');
        const closeGifButton = document.querySelector(".gif-modal-close")
        gifButton.addEventListener('click', (e) => {
            gifModal.classList.toggle('active');

        });

        closeGifButton.addEventListener('click', () => {
            gifModal.classList.remove('active');
        });


        const notiButton = document.querySelector(".chat-header-actions button:first-child");
        const notiModal = document.getElementById("notiModal");
        const closeNotiModal = document.querySelector(".noti-modal-close");

        notiButton.addEventListener('click', () => {

            notiModal.classList.toggle('active');
        });

        closeNotiModal.addEventListener('click', () => {
            notiModal.classList.remove('active');
        });

        document.addEventListener('click', (e) => {
                if (!notiModal.contains(e.target) && !notiButton.contains(e.target) && notiModal.classList.contains('active')) {
                    notiModal.classList.remove('active');
                }
            });







        const sendButton = document.querySelector(".input-actions button:first-child");
        sendButton.addEventListener('click', () => {
            sendMessage()
        });

        const profileBtn = document.querySelector('.profile-button');
        profileBtn.addEventListener('click', () => {

            const username = "{{ request.user.username }}"

            window.location.href = window.location.origin + "/account/" + username;
        });






        const logoutButton = document.querySelector(".chat-header-actions button:nth-child(2)");

        logoutButton.addEventListener('click', () => {

            window.location.href = window.location.host + "/auth" + "/logout/";
        });



        const themeSelect = document.getElementById('themeSelect');


        const elements = {
            body: document.body,
            chatRooms: document.querySelector('.chat-rooms'),
            chatSection: document.querySelector('.chat-section'),
            sideNav: document.querySelector('.side-nav'),
            container: document.querySelector('.container'),
            roomItem: document.querySelector('.room-item'),
            chatRoomsH2: document.querySelector('.chat-rooms h2'),
            addRoom: document.querySelector('.add-room'),
            message: document.querySelector('.message'),
            messageUser: document.querySelector('.message .user'),
            messageSent: document.querySelector('.message.sent'),
            inputArea: document.querySelector('.input-area'),
        };


        const applyTheme = (theme) => {
            if (theme === 'default') {
                elements.body.style.backgroundColor = "#0a0a0a";
                elements.body.style.color = "#fff";
                elements.chatRooms.style.backgroundColor = "#111";
                elements.chatSection.style.backgroundColor = "#0d0d0d";
                elements.sideNav.style.backgroundColor = "#111";
                elements.container.style.backgroundColor = "#0a0a0a";
                elements.roomItem.style.backgroundColor = "#1a1a1a";
                elements.roomItem.style.border = "1px solid #ff336622";
                elements.chatRoomsH2.style.color = "#ff3366";
                elements.addRoom.style.color = "#ff3366";
                elements.message.style.backgroundColor = "#161616";
                elements.messageUser.style.backgroundColor = "#1a1a1a";
                elements.messageSent.style.backgroundColor = "#ff33661a";
                elements.inputArea.style.backgroundColor = "#161616";
            }

            else if (theme === 'blue_pink') {
                elements.body.style.backgroundColor = "#E0F4FF";
                elements.body.style.color = "#FF69B4";
                elements.chatRooms.style.backgroundColor = "#F8FBFF";
                elements.chatSection.style.backgroundColor = "#F0F8FF";
                elements.sideNav.style.backgroundColor = "#CAEDFF";
                elements.container.style.backgroundColor = "#E0F4FF";
                elements.roomItem.style.backgroundColor = "#F8FBFF";
                elements.roomItem.style.border = "1px solid #FF9ECD";
                elements.chatRoomsH2.style.color = "#FF9ECD";
                elements.addRoom.style.color = "#FF9ECD";
                elements.message.style.backgroundColor = "#F8FBFF";
                elements.messageUser.style.backgroundColor = "#FFE4F3";
                elements.messageSent.style.backgroundColor = "#FFE4F3";
                elements.inputArea.style.backgroundColor = "#F0F8FF";
            }



            else if (theme === 'darkcharcoal_yellow') {
                elements.body.style.backgroundColor = "#1A1B1E";
                elements.body.style.color = "#FFD93D";
                elements.chatRooms.style.backgroundColor = "#212428";
                elements.chatSection.style.backgroundColor = "#2A2B2F";
                elements.sideNav.style.backgroundColor = "#2A2B2F";
                elements.container.style.backgroundColor = "#1A1B1E";
                elements.roomItem.style.backgroundColor = "#2A2B2F";
                elements.roomItem.style.border = "1px solid #FFD93D";
                elements.chatRoomsH2.style.color = "#FFE169";
                elements.addRoom.style.color = "#FFD93D";
                elements.message.style.backgroundColor = "#2A2B2F";
                elements.messageUser.style.backgroundColor = "#32333A";
                elements.messageSent.style.backgroundColor = "#FFE169";
                elements.inputArea.style.backgroundColor = "#212428";
            }
            else if (theme === 'lightred_yellow') {
                elements.body.style.backgroundColor = "#FFF3E2";
                elements.body.style.color = "#FF9F9F";
                elements.chatRooms.style.backgroundColor = "#FFE5CA";
                elements.chatSection.style.backgroundColor = "#FFF3E2";
                elements.sideNav.style.backgroundColor = "#FFE5CA";
                elements.container.style.backgroundColor = "#FFF3E2";
                elements.roomItem.style.backgroundColor = "#FFE5CA";
                elements.roomItem.style.border = "1px solid #FF9F9F";
                elements.chatRoomsH2.style.color = "#FF9F9F";
                elements.addRoom.style.color = "#FA9884";
                elements.message.style.backgroundColor = "#FFE5CA";
                elements.messageUser.style.backgroundColor = "#FA9884";
                elements.messageSent.style.backgroundColor = "#FF9F9F";
                elements.inputArea.style.backgroundColor = "#FFE5CA";
            }
            else if (theme === 'darkblue_lightgreen') {
                elements.body.style.backgroundColor = "#1B2430";
                elements.body.style.color = "#9FE6A0";
                elements.chatRooms.style.backgroundColor = "#233142";
                elements.chatSection.style.backgroundColor = "#1B2430";
                elements.sideNav.style.backgroundColor = "#233142";
                elements.container.style.backgroundColor = "#1B2430";
                elements.roomItem.style.backgroundColor = "#233142";
                elements.roomItem.style.border = "1px solid #9FE6A0";
                elements.chatRoomsH2.style.color = "#9FE6A0";
                elements.addRoom.style.color = "#4E9F3D";
                elements.message.style.backgroundColor = "#233142";
                elements.messageUser.style.backgroundColor = "#2C3E50";
                elements.messageSent.style.backgroundColor = "#4E9F3D";
                elements.inputArea.style.backgroundColor = "#233142";
            }
            else if (theme === 'forestgreen_mossgreen') {
                elements.body.style.backgroundColor = "#354F52";
                elements.body.style.color = "#CAD2C5";
                elements.chatRooms.style.backgroundColor = "#52796F";
                elements.chatSection.style.backgroundColor = "#354F52";
                elements.sideNav.style.backgroundColor = "#52796F";
                elements.container.style.backgroundColor = "#354F52";
                elements.roomItem.style.backgroundColor = "#52796F";
                elements.roomItem.style.border = "1px solid #CAD2C5";
                elements.chatRoomsH2.style.color = "#CAD2C5";
                elements.addRoom.style.color = "#84A98C";
                elements.message.style.backgroundColor = "#52796F";
                elements.messageUser.style.backgroundColor = "#84A98C";
                elements.messageSent.style.backgroundColor = "#CAD2C5";
                elements.inputArea.style.backgroundColor = "#52796F";
            }
            else if (theme === 'pastelolivegreen_salmonpink') {
                elements.body.style.backgroundColor = "#E9EDC9";
                elements.body.style.color = "#FF9494";
                elements.chatRooms.style.backgroundColor = "#FEFAE0";
                elements.chatSection.style.backgroundColor = "#E9EDC9";
                elements.sideNav.style.backgroundColor = "#CCD5AE";
                elements.container.style.backgroundColor = "#E9EDC9";
                elements.roomItem.style.backgroundColor = "#FEFAE0";
                elements.roomItem.style.border = "1px solid #FF9494";
                elements.chatRoomsH2.style.color = "#FF9494";
                elements.addRoom.style.color = "#FFB4B4";
                elements.message.style.backgroundColor = "#FEFAE0";
                elements.messageUser.style.backgroundColo = "#FFB4B4";
                elements.messageSent.style.backgroundColor = "#FF9494";
                elements.inputArea.style.backgroundColor = "#FEFAE0";
            }

        }

        const savedTheme = localStorage.getItem('theme')
        applyTheme(savedTheme);
        themeSelect.value = savedTheme;

        themeSelect.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            localStorage.setItem('theme', selectedTheme);
            applyTheme(selectedTheme)

        });



        const roomName = "{{ chat_room.room_name }}";
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
        );

        const likeSong = document.getElementById("like-song");
        likeSong.addEventListener("click", () => {
            const songs = "{{ songs.title|escapejs }}";
            chatSocket.send(JSON.stringify({
                'type': 'song',
                'song': songs
            }));
        });

        const inputChatBox = document.querySelector(".input-chat-box")
        const username = '{{request.user.username}}'
        let typingTimeout;
        inputChatBox.addEventListener('input', () => {

            clearTimeout(typingTimeout);

            try {

                chatSocket.send(JSON.stringify({
                    'type': 'typeindicator',
                    'username': username,
                    'status': 'typing'
                }));


                typingTimeout = setTimeout(() => {
                    chatSocket.send(JSON.stringify({
                        'type': 'stopped_typing',
                    }));
                }, 1000);
            } catch (error) {
                console.error('Error sending typing indicator:', error);
            }
        });


        document.body.addEventListener('click', (event) => {
            if (event.target && event.target.classList.contains('randomSongYes')) {
                console.log("working")
                chatSocket.send(JSON.stringify({
                    'type': "change_song",
                }));
            }
        });

        function scrollToBottom() {
            const chatMessages = document.querySelector('.chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        scrollToBottom();


        function escapeHTML(html) {
            const div = document.createElement('div');
            div.innerText = html;
            return div.innerHTML;
        }



        const messageInput = document.querySelector('.input-area input');

        /*
            if (e.key == "/") {
                const searchInput = document.querySelector('.input-area input');
                e.preventDefault();
                searchInput.focus();
            }
        });
         */


        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function userJoinLeaveMessage(message) {
            const chatMessages = document.querySelector('.chat-messages');
            const newMessage = document.createElement('div');
            newMessage.className = 'system message';

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            newMessage.innerHTML = `
                {% comment %} <div class="user">System</div> {% endcomment %}
                <div class="message-content">${message}</div>
                <div class="timestamp">${time}</div>
            `;


            chatMessages.appendChild(newMessage);
            scrollToBottom();
            messageInput.value = '';
        }

        const nextSong = document.querySelector(".next-song");
        if (nextSong) {
            nextSong.addEventListener('click', () => {

                chatSocket.send(JSON.stringify({
                    'type': "change_song",

                }))
            });
        }

        const selectors = [".gif-image", ".sent-image"];
        const modal = document.getElementById("imageModal");
        const modalContent = modal.querySelector(".image-area");

        selectors.forEach(selector => {
            document.querySelectorAll(selector).forEach(element => {
                element.addEventListener("click", (event) => {
                    modalContent.innerHTML = "";
                    const img = document.createElement("img");
                    img.src = event.target.src;
                    modalContent.appendChild(img);
                    modal.classList.add("active");
                });
            });
        });

        modal.addEventListener("click", (event) => {
            if (event.target === modal) {
                modal.classList.remove("active");
            }
        });




        function sendMessage(msg) {
            var message = messageInput.value.trim();
            if (msg) {
                message = msg;
            }

            const chat_room = "{{chat_room}}"
            if (message) {
                chatSocket.send(JSON.stringify({
                    'type': "send_message",
                    'message': message,
                    'ChatRoom': chat_room
                }));
                messageInput.value = '';
            }
        }


        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);


            if (data.type === 'songResult') {
                if (data.songResult == "Present") {
                    alert("Song already present");
                }
                else {
                    alert("song added");

                }
            }
            else if (data.type === 'typeindicator') {
                const username = "{{ request.user.username|escapejs }}";
                if (username != data.username) {
                    const typeIndicatorArea = document.querySelector(".type-indicator-area");
                    typeIndicatorArea.innerHTML = `${data.username} is typing...`;

                }


            }

            else if (data.type === "stopped_typing") {
                const typeIndicatorArea = document.querySelector(".type-indicator-area");
                typeIndicatorArea.innerHTML = ``;

            }

            else if (data.type === 'change_song') {

                const musicPlayer = document.querySelector(".music-player");

                const albumArt = musicPlayer.querySelector(".album-art");
                if (albumArt) {
                    albumArt.src = data.song_thumbnail;
                }

                const trackInfo = musicPlayer.querySelector(".track-info");
                if (trackInfo) {
                    const titleElement = trackInfo.querySelector("h3");
                    if (titleElement) {
                        titleElement.textContent = data.song_title;
                    }
                    const artistElement = trackInfo.querySelector("p");
                    if (artistElement) {
                        artistElement.textContent = data.song_artist;
                    }


                    const audioElement = musicPlayer.querySelector("audio source");
                    if (audioElement) {
                        audioElement.src = data.song;
                        // Reload the audio to reflect the new source
                        const audioParent = audioElement.closest("audio");
                        if (audioParent) {
                            audioParent.load();
                            audioParent.play();
                        }
                    }


                }
            }



            else if (data.type == "add_update") {
                addUserResult = data.addUserResult
                alert(addUserResult)

            }
            else if (data.type == "remove_update") {
                removeUserResult = data.removeUserResult
                alert(removeUserResult)
            }


            else if (data.type == "remove_update_all") {

                const username = "{{ request.user.username|escapejs }}";
                if (username == data.updateUsername) {

                    window.location.href = window.location.origin + "/home/chat/General_Chat/";
                }
            }


            else if (data.type === "delete_message") {


                const messageID = data.message_id;

                const messageToDelete = document.getElementById(messageID);
                if (messageToDelete) {
                    const messageDelete = messageToDelete.parentNode
                    const username = messageToDelete.querySelector('#messageUsername').innerText;
                    const currentUser = "{{request.user.username}}"
                    if (currentUser != username) {


                        if (messageDelete) {
                            messageDelete.remove()
                        }
                    }
                }


            }


            else if (data.type === "online_count") {
                document.getElementById('online-count').textContent = data.online_count + " active";
                if (data.identifier === 'joined') {
                    userJoinLeaveMessage(`Welcome to the ChatRoom, ${data.recently_joined}`)
                }

                const onlineUserList = document.querySelector(".users-list");
                onlineUserList.innerHTML = '';



                for (let user of data.online_users) {
                    const li = document.createElement('li');

                    const spanUser = document.createElement('span');

                    const profileUrl = `/account/${user}`;
                    spanUser.innerHTML = `<a href="${profileUrl}">${user}</a>`;

                    const spanStatus = document.createElement('span');
                    spanStatus.classList.add('status');

                    li.appendChild(spanUser);
                    li.appendChild(spanStatus);

                    onlineUserList.appendChild(li);
                }

            }

            else {

                const { message, username, profilePicture, messageID } = data;
                const currentUser = "{{ request.user.username }}";




                if (username !== currentUser) {
                    const chatMessages = document.querySelector('.chat-messages');
                    const newMessage = document.createElement('div');
                    newMessage.className = 'message';



                    const time = new Date().toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });


                    const imgElement = document.createElement('img');
                    imgElement.src = profilePicture;
                    imgElement.alt = 'userimage';

                    const userDiv = document.createElement('div');
                    userDiv.className = 'user';
                    userDiv.id = messageID;

                    const usernameLink = document.createElement('a');
                    usernameLink.id = 'messageUsername';

                    usernameLink.href = `/account/${encodeURIComponent(username)}`;
                    usernameLink.textContent = username;

                    const timestampDiv = document.createElement('div');
                    timestampDiv.className = 'timestamp';
                    timestampDiv.textContent = time;

                    if (message.startsWith("https://media.tenor.com") || (message.startsWith("https://res.cloudinary.com"))) {

                        const messageImg = document.createElement('img');
                        messageImg.src = message;
                        messageImg.className = "gif-image";


                        userDiv.appendChild(usernameLink);
                        userDiv.appendChild(timestampDiv);
                        userDiv.appendChild(messageImg);

                        newMessage.appendChild(imgElement);
                        newMessage.appendChild(userDiv);

                    }


                    else {
                        const messageHeading = document.createElement('h3');
                        messageHeading.textContent = escapeHTML(message);


                        userDiv.appendChild(usernameLink);
                        userDiv.appendChild(timestampDiv);
                        userDiv.appendChild(messageHeading);

                        newMessage.appendChild(imgElement);
                        newMessage.appendChild(userDiv);



                    }
                    chatMessages.appendChild(newMessage);
                    scrollToBottom();
                }

                else {

                    const messageInput = document.querySelector('.input-area input');
                    if (message) {


                        const chatMessages = document.querySelector('.chat-messages');
                        const newMessage = document.createElement('div');
                        newMessage.className = 'message sent';

                        if (message.startsWith("https://media.tenor.com") || (message.startsWith("https://res.cloudinary.com"))) {
                            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            newMessage.innerHTML = `
                                <img src={{ request.user.profilePicture }} alt="userimage">
                                    <div class="user" id = "${messageID}">You
                                    <button class="delete-message"><i class="fas fa-trash"></i></button>
                                    <div class="timestamp">${time}</div>
                                   <img src="${message}" class="gif-image">

                                    </div>
                                `;
                        }



                        else {
                            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const sanitizedMessage = escapeHTML(message);
                            newMessage.innerHTML = `
                            <img src={{ request.user.profilePicture }} alt="userimage">
                                <div class="user" id = "${messageID}">You
                                <button class="delete-message"><i class="fas fa-trash"></i></button>
                                <div class="timestamp">${time}</div>
                               <h3 class="text-message"> ${sanitizedMessage} </h3>
                                </div>
                            `;
                        }

                        chatMessages.appendChild(newMessage);
                        scrollToBottom();

                    }

                }

            }
        };



        async function deleteMessageFunc(messageid) {
            try {


                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const url = `deletemessage/${messageid}/`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,

                    },

                });

                if (response.ok) {

                    chatSocket.send(JSON.stringify({
                        type: 'delete_message',
                        message_id: messageid,
                    }));
                }
            }
            catch (error) {
                console.error(error)
            }
        }

        document.addEventListener('click', async (e) => {
            const deleteMessageButton = e.target.closest(".delete-message");
            if (deleteMessageButton) {

                const userDiv = deleteMessageButton.closest(".user");
                const messageSentDiv = deleteMessageButton.closest(".message.sent")
                if (userDiv) {
                    messageSentDiv.remove()
                    await deleteMessageFunc(userDiv.id)

                }
            }
        });

        const attachmentBtn = document.querySelector('.input-actions button:nth-child(3)');
        const fileUpload = document.getElementById('fileUpload');

        attachmentBtn.addEventListener('click', () => {
            fileUpload.click();
        });

        async function uploadFile(image) {
            const formData = new FormData();

            const CLOUD_NAME = "dv2qm6ktz";
            const UPLOAD_PRESET = "chatwave";
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            formData.append('file', image);
            formData.append('upload_preset', UPLOAD_PRESET)

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData,

                });
                const result = await response.json();
                return result


            }
            catch (error) {
                console.error('Error uploading file:', error);
                return "error";
            }
        }

        fileUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {

                const Imageurl = await uploadFile(file)
                console.log(Imageurl['secure_url']);
                sendMessage(Imageurl['secure_url']);
            }
        });


    });

</script>
</body>

</html>